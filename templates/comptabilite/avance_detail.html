{% extends "base.html" %}

{% block title %}Avance {{ avance.numero }} - CREATES{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-cash-stack"></i> Avance {{ avance.numero }}</h2>
    <div>
        {% if avance.statut in ['en_attente', 'justifiee'] %}
        <a href="{{ url_for('justifier_avance', id=avance.id) }}" class="btn btn-success">
            <i class="bi bi-receipt"></i> Justifier
        </a>
        {% endif %}
        {% if avance.statut not in ['soldee', 'deduite'] and current_user.role == 'directeur' %}
        <form method="POST" action="{{ url_for('deduire_avance', id=avance.id) }}" class="d-inline">
            <button type="submit" class="btn btn-warning" onclick="return confirm('Confirmer la déduction du salaire?')">
                <i class="bi bi-exclamation-triangle"></i> Marquer comme déduite
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('liste_avances') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>
</div>

{% if avance.est_en_retard %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <strong>Attention!</strong> Cette avance est en retard de {{ avance.jours_retard }} jours.
    Date limite: {{ avance.date_limite.strftime('%d/%m/%Y') }}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">Informations de l'avance</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Numéro:</strong></div>
                    <div class="col-md-8">{{ avance.numero }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Date:</strong></div>
                    <div class="col-md-8">{{ avance.date_avance.strftime('%d/%m/%Y') }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Bénéficiaire:</strong></div>
                    <div class="col-md-8">{{ avance.beneficiaire }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Objet:</strong></div>
                    <div class="col-md-8">{{ avance.objet }}</div>
                </div>
                {% if avance.projet %}
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Projet:</strong></div>
                    <div class="col-md-8">{{ avance.projet.code }} - {{ avance.projet.nom }}</div>
                </div>
                {% endif %}
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Date limite:</strong></div>
                    <div class="col-md-8">
                        {{ avance.date_limite.strftime('%d/%m/%Y') if avance.date_limite else '-' }}
                        {% if avance.est_en_retard %}
                        <span class="badge bg-danger ms-2">En retard</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Statut:</strong></div>
                    <div class="col-md-8">
                        {% if avance.statut == 'en_attente' %}
                        <span class="badge bg-warning text-dark">En attente de justification</span>
                        {% elif avance.statut == 'justifiee' %}
                        <span class="badge bg-info">Justifiée (partiellement)</span>
                        {% elif avance.statut == 'soldee' %}
                        <span class="badge bg-success">Soldée</span>
                        {% elif avance.statut == 'deduite' %}
                        <span class="badge bg-secondary">Déduite du salaire</span>
                        {% endif %}
                    </div>
                </div>
                {% if avance.justification_notes %}
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Notes:</strong></div>
                    <div class="col-md-8">{{ avance.justification_notes }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">Montants</div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Montant avance:</span>
                    <strong>{{ "{:,.0f}".format(avance.montant) }} FCFA</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Justifié:</span>
                    <span class="text-success">{{ "{:,.0f}".format(avance.montant_justifie) }} FCFA</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Remboursé:</span>
                    <span class="text-info">{{ "{:,.0f}".format(avance.montant_rembourse) }} FCFA</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Solde restant:</strong>
                    <strong class="{% if avance.solde_restant > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ "{:,.0f}".format(avance.solde_restant) }} FCFA
                    </strong>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Historique</div>
            <div class="card-body">
                <small>
                    <p><strong>Créée le:</strong> {{ avance.date_creation.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p><strong>Par:</strong> {{ avance.cree_par }}</p>
                    {% if avance.date_justification %}
                    <p><strong>Justifiée le:</strong> {{ avance.date_justification.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                    {% if avance.date_solde %}
                    <p><strong>Soldée le:</strong> {{ avance.date_solde.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}
