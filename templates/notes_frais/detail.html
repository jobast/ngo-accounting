{% extends "base.html" %}
{% block title %}Note de Frais {{ note.numero }} - CREATES{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('liste_notes_frais') }}">Notes de Frais</a></li>
            <li class="breadcrumb-item active">{{ note.numero }}</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h2><i class="bi bi-receipt me-2"></i>{{ note.numero }}</h2>
            <p class="text-muted mb-0">
                {% if note.statut == 'brouillon' %}
                <span class="badge bg-secondary fs-6">Brouillon</span>
                {% elif note.statut == 'soumis' %}
                <span class="badge bg-warning text-dark fs-6">En attente d'approbation</span>
                {% elif note.statut == 'approuve' %}
                <span class="badge bg-success fs-6">Approuvé</span>
                {% elif note.statut == 'rejete' %}
                <span class="badge bg-danger fs-6">Rejeté</span>
                {% elif note.statut == 'rembourse' %}
                <span class="badge bg-info fs-6">Remboursé</span>
                {% endif %}
            </p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('pdf_note_frais', id=note.id) }}" class="btn btn-outline-danger" target="_blank">
                <i class="bi bi-file-pdf me-1"></i>PDF
            </a>
            {% if note.est_modifiable and (note.employe_id == current_user.id or current_user.role == 'directeur') %}
            <a href="{{ url_for('modifier_note_frais', id=note.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>Modifier
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Détails de la dépense -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>Détails de la dépense
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 40%;">Date dépense</th>
                                <td>{{ note.date_depense.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Catégorie</th>
                                <td>
                                    {% for cat_code, cat_nom in note.CATEGORIES %}
                                        {% if cat_code == note.categorie %}{{ cat_nom }}{% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Montant</th>
                                <td class="fs-4 fw-bold text-primary">{{ "{:,.0f}".format(note.montant) }} FCFA</td>
                            </tr>
                            <tr>
                                <th class="text-muted">À rembourser</th>
                                <td>
                                    {% if note.a_rembourser %}
                                    <span class="badge bg-success">Oui</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Non</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 40%;">Employé</th>
                                <td>{{ note.employe.nom }} {{ note.employe.prenom or '' }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Projet</th>
                                <td>
                                    {% if note.projet %}
                                    <span class="badge bg-primary">{{ note.projet.code }}</span>
                                    {{ note.projet.nom }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Ligne budget</th>
                                <td>
                                    {% if note.ligne_budget %}
                                    {{ note.ligne_budget.code }} - {{ note.ligne_budget.intitule }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <h6 class="text-muted">Description</h6>
                    <p class="border rounded p-3 bg-light">{{ note.description }}</p>
                </div>

                {% if note.justificatif %}
                <div class="mt-3">
                    <h6 class="text-muted">Justificatif</h6>
                    <a href="{{ url_for('serve_upload', filename=note.justificatif) }}" target="_blank" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark me-1"></i>Voir le justificatif
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Motif de rejet si applicable -->
        {% if note.statut == 'rejete' and note.motif_rejet %}
        <div class="alert alert-danger">
            <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Motif du rejet</h6>
            <p class="mb-0">{{ note.motif_rejet }}</p>
            <hr>
            <small>Rejeté par {{ note.validateur.nom if note.validateur else 'N/A' }} le {{ note.date_validation.strftime('%d/%m/%Y à %H:%M') if note.date_validation else 'N/A' }}</small>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-gear me-2"></i>Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if note.peut_soumettre and note.employe_id == current_user.id %}
                    <form method="POST" action="{{ url_for('soumettre_note_frais', id=note.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-send me-2"></i>Soumettre pour approbation
                        </button>
                    </form>
                    {% endif %}

                    {% if note.peut_approuver and current_user.role in ['comptable', 'directeur'] %}
                    <form method="POST" action="{{ url_for('approuver_note_frais', id=note.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-check-circle me-2"></i>Approuver
                        </button>
                    </form>

                    <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#modalRejet">
                        <i class="bi bi-x-circle me-2"></i>Rejeter
                    </button>
                    {% endif %}

                    {% if note.statut == 'approuve' and current_user.role in ['comptable', 'directeur'] %}
                    <form method="POST" action="{{ url_for('rembourser_note_frais', id=note.id) }}">
                        <button type="submit" class="btn btn-info w-100">
                            <i class="bi bi-cash-coin me-2"></i>Marquer comme remboursé
                        </button>
                    </form>
                    {% endif %}

                    <a href="{{ url_for('liste_notes_frais') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour à la liste
                    </a>
                </div>
            </div>
        </div>

        <!-- Historique -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history me-2"></i>Historique
            </div>
            <div class="card-body small">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-plus-circle text-success me-1"></i>
                        Créée le {{ note.date_creation.strftime('%d/%m/%Y à %H:%M') }}
                        <br><small class="text-muted">par {{ note.cree_par or note.employe.email }}</small>
                    </li>
                    {% if note.date_soumission %}
                    <li class="mb-2">
                        <i class="bi bi-send text-primary me-1"></i>
                        Soumise le {{ note.date_soumission.strftime('%d/%m/%Y à %H:%M') }}
                    </li>
                    {% endif %}
                    {% if note.date_validation %}
                    <li class="mb-2">
                        {% if note.statut == 'approuve' or note.statut == 'rembourse' %}
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Approuvée le {{ note.date_validation.strftime('%d/%m/%Y à %H:%M') }}
                        {% elif note.statut == 'rejete' %}
                        <i class="bi bi-x-circle text-danger me-1"></i>
                        Rejetée le {{ note.date_validation.strftime('%d/%m/%Y à %H:%M') }}
                        {% endif %}
                        <br><small class="text-muted">par {{ note.validateur.nom if note.validateur else 'N/A' }}</small>
                    </li>
                    {% endif %}
                    {% if note.date_remboursement %}
                    <li class="mb-2">
                        <i class="bi bi-cash-coin text-info me-1"></i>
                        Remboursée le {{ note.date_remboursement.strftime('%d/%m/%Y à %H:%M') }}
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de rejet -->
{% if note.peut_approuver and current_user.role in ['comptable', 'directeur'] %}
<div class="modal fade" id="modalRejet" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('rejeter_note_frais', id=note.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Rejeter la note de frais</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Motif du rejet *</label>
                        <textarea class="form-control" name="motif_rejet" rows="3" required
                                  placeholder="Expliquez pourquoi cette note de frais est rejetée..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle me-1"></i>Rejeter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
